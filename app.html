<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Afnan Chat - Elite Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; margin: 0; padding: 0; background-color: #000000; color: #ffffff; font-family: 'Noto Sans Arabic', sans-serif; overflow: hidden; }
        
        .loading-screen {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #FFA500;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Navigation Views */
        .view-screen { position: absolute; inset: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; z-index: 10; padding-top: 80px; }
        .view-screen.active { display: flex; }

        /* App Header */
        .app-header { position: fixed; top: 0; right: 0; left: 0; height: 80px; background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: space-between; padding: 0 1.2rem; z-index: 1000; }
        
        /* Sidebar Navigation */
        .sidebar { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background: #0a0a0a; z-index: 4000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-left: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        .sidebar.open { right: 0; }
        .sidebar-item { display: flex; align-items: center; gap: 15px; padding: 14px 20px; cursor: pointer; border-radius: 12px; margin: 2px 10px; transition: 0.2s; }
        .sidebar-item:active { background: rgba(255,255,255,0.05); }

        /* Wallet Styles */
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 25px; text-align: center; }
        .buy-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; padding: 15px; text-align: center; }

        /* Bottom Sheets */
        .bottom-sheet { position: fixed; bottom: 0; right: 0; left: 0; background: rgba(15, 15, 15, 0.98); backdrop-filter: blur(40px); border-top: 1px solid rgba(255, 255, 255, 0.15); border-radius: 30px 30px 0 0; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 3000; }
        .bottom-sheet.open { transform: translateY(0); }

        /* Chat Layout */
        .chat-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; font-size: 14px; position: relative; }
        .msg-me { background: #FFA500; color: #000; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-them { background: rgba(255,255,255,0.1); color: #fff; align-self: flex-start; border-bottom-left-radius: 4px; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2500; display: none; backdrop-filter: blur(5px); }
        .overlay.active { display: block; }
        
        .gift-item { display: flex; flex-direction: column; align-items: center; padding: 15px; border-radius: 15px; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.3s; }
        .gift-item:hover { background: rgba(255,255,255,0.1); }
        
        .error-screen {
            position: fixed;
            inset: 0;
            background: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
            z-index: 10002;
        }
        
        .error-screen h2 {
            color: #ff4444;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .error-screen p {
            color: #ccc;
            margin-bottom: 30px;
            max-width: 400px;
        }
        
        .retry-btn {
            background: #FFA500;
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .retry-btn:hover {
            background: #ff8c00;
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loading-screen" class="loading-screen">
        <div class="loader"></div>
        <div style="margin-top: 20px; color: white; opacity: 0.7; font-size: 14px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø·Ø£ -->
    <div id="error-screen" class="error-screen">
        <h2>âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h2>
        <p>ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø¬Ø¯ÙŠØ¯.</p>
        <button onclick="retryLoad()" class="retry-btn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        <button onclick="goToLogin()" style="margin-top: 15px; background: transparent; color: #FFA500; border: 1px solid #FFA500; padding: 10px 20px; border-radius: 10px; cursor: pointer;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="main-app" style="display: none; height: 100%;">
        <!-- Shared Header -->
        <header class="app-header">
            <button onclick="toggleSidebar()" class="p-3 bg-white/5 rounded-2xl"><i data-lucide="menu"></i></button>
            <div class="text-center">
                <span class="text-[9px] font-bold tracking-widest opacity-40 uppercase" id="screen-subtitle">Afnan Network</span>
                <div class="text-sm font-bold" id="screen-title">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            </div>
            <div id="header-action">
                <div class="w-11 h-11 rounded-full bg-white/5 flex items-center justify-center"><i data-lucide="globe" class="opacity-50"></i></div>
            </div>
        </header>

        <!-- Sidebar Menu -->
        <div id="sidebar" class="sidebar">
            <div class="p-8 text-center border-b border-white/5">
                <img id="user-avatar" src="https://i.pravatar.cc/150?u=me" class="w-20 h-20 rounded-full mx-auto border-2 border-orange-500 mb-3 shadow-lg shadow-orange-500/20">
                <div id="user-name" class="font-bold text-lg">Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</div>
                <div id="user-id" class="text-[10px] opacity-40">ID: ...</div>
            </div>
            
            <div class="mt-[30px] flex-1">
                <div class="sidebar-item" onclick="switchView('wallet')">
                    <i data-lucide="wallet" class="text-orange-500"></i>
                    <span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
                </div>
                <div class="sidebar-item" onclick="switchView('friends')">
                    <i data-lucide="users" class="text-blue-400"></i>
                    <span>Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</span>
                </div>
                <div class="sidebar-item" onclick="showStore()">
                    <i data-lucide="shopping-bag" class="text-purple-400"></i>
                    <span>Ø§Ù„Ù…ØªØ¬Ø±</span>
                </div>
            </div>

            <div class="p-5">
                <button onclick="logoutUser()" class="w-full flex items-center justify-center gap-2 p-4 bg-red-500/10 text-red-500 rounded-2xl font-bold">
                    <i data-lucide="log-out"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>

        <!-- VIEW 1: Public Chat -->
        <div id="view-public" class="view-screen active">
            <div id="public-chat-list" class="chat-content"></div>
            <footer class="p-4 bg-black/50 backdrop-blur-md">
                <div class="bg-white/5 rounded-full p-2 flex items-center border border-white/10">
                    <button onclick="openGiftSheet()" class="p-3 text-orange-400"><i data-lucide="gift"></i></button>
                    <input id="public-input" class="flex-1 bg-transparent border-none outline-none p-2 text-sm" placeholder="Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹...">
                    <button onclick="sendMessage('public')" class="bg-white text-black p-3 rounded-full"><i data-lucide="send"></i></button>
                </div>
            </footer>
        </div>

        <!-- VIEW 2: Wallet -->
        <div id="view-wallet" class="view-screen">
            <div class="p-6">
                <div class="glass-card mb-10">
                    <div class="text-[10px] opacity-50 mb-1">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                    <div id="wallet-balance" class="text-4xl font-bold text-orange-500">27,000 <span class="text-xs">ğŸ’°</span></div>
                </div>

                <div class="grid grid-cols-3 gap-3 mt-[50px]">
                    <div class="buy-card">
                        <div class="text-[10px] opacity-50 mb-1">+27,000</div>
                        <div class="font-bold text-sm mb-3">1 Ø¯ÙˆÙ„Ø§Ø±</div>
                        <button onclick="addBalance(27000)" class="w-full py-2 bg-white/10 rounded-xl text-[10px] font-bold">Ø´Ø±Ø§Ø¡</button>
                    </div>
                    <div class="buy-card">
                        <div class="text-[10px] opacity-50 mb-1">+140,000</div>
                        <div class="font-bold text-sm mb-3">5 Ø¯ÙˆÙ„Ø§Ø±</div>
                        <button onclick="addBalance(140000)" class="w-full py-2 bg-white/10 rounded-xl text-[10px] font-bold">Ø´Ø±Ø§Ø¡</button>
                    </div>
                    <div class="buy-card">
                        <div class="text-[10px] opacity-50 mb-1">+300,000</div>
                        <div class="font-bold text-sm mb-3">10 Ø¯ÙˆÙ„Ø§Ø±</div>
                        <button onclick="addBalance(300000)" class="w-full py-2 bg-white/10 rounded-xl text-[10px] font-bold">Ø´Ø±Ø§Ø¡</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: Friends -->
        <div id="view-friends" class="view-screen">
            <div class="p-4 flex flex-col gap-2" id="friends-list">
                <div class="opacity-30 text-center mt-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
            </div>
        </div>

        <!-- Bottom Sheet Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§ -->
        <div id="gift-sheet" class="bottom-sheet" style="height: 60vh; padding: 20px;">
            <div class="text-center mb-6">
                <div class="text-lg font-bold">Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©</div>
                <div class="text-xs opacity-50">Ø§Ø®ØªØ± Ù‡Ø¯ÙŠØ© Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§</div>
            </div>
            
            <div class="grid grid-cols-3 gap-3">
                <div class="gift-item" onclick="sendGift(1000, 'ğŸ')">
                    <div class="text-2xl mb-2">ğŸ</div>
                    <div class="text-xs">Ù‡Ø¯ÙŠØ© Ø¨Ø³ÙŠØ·Ø©</div>
                    <div class="text-xs text-orange-500 mt-1">1,000 ğŸ’°</div>
                </div>
                <div class="gift-item" onclick="sendGift(5000, 'ğŸ’')">
                    <div class="text-2xl mb-2">ğŸ’</div>
                    <div class="text-xs">Ù‡Ø¯ÙŠØ© Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠØ©</div>
                    <div class="text-xs text-orange-500 mt-1">5,000 ğŸ’°</div>
                </div>
                <div class="gift-item" onclick="sendGift(10000, 'ğŸ‘‘')">
                    <div class="text-2xl mb-2">ğŸ‘‘</div>
                    <div class="text-xs">ØªØ§Ø¬ Ù…Ù„ÙƒÙŠ</div>
                    <div class="text-xs text-orange-500 mt-1">10,000 ğŸ’°</div>
                </div>
                <div class="gift-item" onclick="sendGift(15000, 'ğŸš€')">
                    <div class="text-2xl mb-2">ğŸš€</div>
                    <div class="text-xs">ØµØ§Ø±ÙˆØ®</div>
                    <div class="text-xs text-orange-500 mt-1">15,000 ğŸ’°</div>
                </div>
                <div class="gift-item" onclick="sendGift(20000, 'ğŸ†')">
                    <div class="text-2xl mb-2">ğŸ†</div>
                    <div class="text-xs">ÙƒØ£Ø³ Ø°Ù‡Ø¨ÙŠ</div>
                    <div class="text-xs text-orange-500 mt-1">20,000 ğŸ’°</div>
                </div>
                <div class="gift-item" onclick="sendGift(50000, 'ğŸ’')">
                    <div class="text-2xl mb-2">ğŸ’</div>
                    <div class="text-xs">Ù…Ø§Ø³Ø© Ù†Ø§Ø¯Ø±Ø©</div>
                    <div class="text-xs text-orange-500 mt-1">50,000 ğŸ’°</div>
                </div>
            </div>
            
            <button onclick="closeGiftSheet()" class="w-full mt-6 py-3 bg-white/10 rounded-xl text-sm font-bold">Ø¥Ù„ØºØ§Ø¡</button>
        </div>

        <div id="overlay" class="overlay" onclick="closeAll()"></div>
    </div>

    <!-- Firebase SDK Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    <script type="module">
        // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { 
            getAuth, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            updateDoc,
            setDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCyCqrlFUn1UJr29tJGqikSNwsSo5_ieJo",
            authDomain: "afnan-6a676.firebaseapp.com",
            projectId: "afnan-6a676",
            storageBucket: "afnan-6a676.firebasestorage.app",
            messagingSenderId: "751685607902",
            appId: "1:751685607902:web:11c8b40bc6c2a848c2bd4f",
            measurementId: "G-H6LH98L5ER"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let currentUser = null;
        let currentBalance = 27000;

        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function hideLoading() {
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
            }, 500);
        }

        // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø·Ø£
        function showError(message = "") {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('error-screen').style.display = 'flex';
            
            if (message) {
                document.querySelector('#error-screen p').textContent = message;
            }
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø®Ø·Ø£
        function hideError() {
            document.getElementById('error-screen').style.display = 'none';
        }

        // âœ… Ø§Ù„Ø­Ù„: Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ID ÙØ±ÙŠØ¯ Ù…ÙƒÙˆÙ† Ù…Ù† 8 Ø£Ø±Ù‚Ø§Ù…
        function generateUniqueId() {
            // ØªÙˆÙ„ÙŠØ¯ 8 Ø£Ø±Ù‚Ø§Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
            return Math.floor(10000000 + Math.random() * 90000000).toString();
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Firestore
        async function updateUserBalance(newBalance) {
            if (!currentUser) {
                alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return false;
            }
            
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, {
                    balance: newBalance
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                currentBalance = newBalance;
                currentUser.balance = newBalance;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                const balanceDisplay = document.getElementById('wallet-balance');
                if (balanceDisplay) {
                    balanceDisplay.textContent = newBalance.toLocaleString() + " ğŸ’°";
                }
                
                return true;
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯:", error);
                return false;
            }
        }

        // âœ…âœ…âœ… Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø¹Ø¯Ù„: onAuthStateChanged ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        onAuthStateChanged(auth, async (user) => {
            console.log("ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...");
            
            if (user) {
                console.log("âœ… Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„:", user.email);
                
                try {
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    let userData;
                    
                    if (!userSnap.exists()) {
                        // âœ…âœ…âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ù†Ù†Ø´Ø¦ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ ÙÙŠ Firestore
                        const newUserId = generateUniqueId();
                        userData = {
                            uid: user.uid,
                            userId: newUserId,
                            displayName: user.displayName || "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯",
                            email: user.email || "",
                            photoURL: user.photoURL || "https://i.pravatar.cc/150?u=" + user.uid,
                            balance: 27000,
                            createdAt: serverTimestamp(),
                            lastLogin: serverTimestamp()
                        };
                        
                        await setDoc(userRef, userData);
                        console.log("ğŸ†• Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡:", newUserId);
                    } else {
                        // âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯: Ù†Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
                        userData = userSnap.data();
                        
                        // âœ… Ù†Ø­Ø¯Ø« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
                        await updateDoc(userRef, {
                            lastLogin: serverTimestamp()
                        });
                        
                        console.log("ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ÙŠÙ…:", userData.userId);
                    }
                    
                    // âœ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    const userAvatar = document.getElementById('user-avatar');
                    const userName = document.getElementById('user-name');
                    const userIdDisplay = document.getElementById('user-id');
                    const balanceDisplay = document.getElementById('wallet-balance');
                    
                    if (userAvatar) userAvatar.src = userData.photoURL;
                    if (userName) userName.textContent = userData.displayName;
                    if (userIdDisplay) userIdDisplay.textContent = `ID: ${userData.userId}`;
                    if (balanceDisplay) balanceDisplay.textContent = userData.balance.toLocaleString() + " ğŸ’°";
                    
                    // âœ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
                    currentUser = {
                        uid: user.uid,
                        userId: userData.userId,
                        displayName: userData.displayName,
                        photoURL: userData.photoURL,
                        balance: userData.balance
                    };
                    currentBalance = userData.balance;
                    
                    // âœ… Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                    hideLoading();
                    hideError();
                    document.getElementById('main-app').style.display = 'block';
                    
                    console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­");
                    
                } catch (error) {
                    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
                    showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ: " + error.message);
                }
                
            } else {
                console.log("ğŸšª Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ - Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 1000);
            }
        });

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.logoutUser = async function() {
            try {
                await signOut(auth);
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                window.location.href = "index.html";
                
                console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­");
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
            }
        };

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.retryLoad = function() {
            hideError();
            document.getElementById('loading-screen').style.display = 'flex';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„
            setTimeout(() => {
                location.reload();
            }, 500);
        };

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.goToLogin = function() {
            window.location.href = "index.html";
        };

        // Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
        window.updateUserBalance = updateUserBalance;
        window.firebaseAuth = auth;
        
        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ (Ù„Ù„Ø§Ø­ØªÙŠØ§Ø·)
        setTimeout(() => {
            hideLoading();
        }, 5000);
    </script>

    <!-- JavaScript Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <script>
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
        lucide.createIcons();
        
        // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
        function switchView(viewId) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
            document.querySelectorAll('.view-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            // ØªØ­Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            const titles = {
                'public': ['Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©', 'Afnan Network'],
                'wallet': ['Ø§Ù„Ù…Ø­ÙØ¸Ø©', 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØµÙŠØ¯'],
                'friends': ['Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ', 'Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©']
            };
            
            if (titles[viewId]) {
                document.getElementById('screen-title').innerText = titles[viewId][0];
                document.getElementById('screen-subtitle').innerText = titles[viewId][1];
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
            const actionArea = document.getElementById('header-action');
            if (viewId !== 'public') {
                actionArea.innerHTML = `<button onclick="switchView('public')" class="p-3 bg-white/5 rounded-2xl"><i data-lucide="arrow-left"></i></button>`;
            } else {
                actionArea.innerHTML = `<div class="w-11 h-11 rounded-full bg-white/5 flex items-center justify-center"><i data-lucide="globe" class="opacity-50"></i></div>`;
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
            lucide.createIcons();
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
            closeAll();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function closeAll() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('gift-sheet').classList.remove('open');
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯
        window.addBalance = async function(amount) {
            if (!window.currentUser) {
                alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const newBalance = window.currentUser.balance + amount;
            const success = await window.updateUserBalance(newBalance);
            
            if (success) {
                alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${amount.toLocaleString()} Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ!`);
            } else {
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡');
            }
        };

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ© (ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯)
        async function sendGift(cost, gift) {
            if (!window.currentUser) {
                alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (window.currentUser.balance < cost) {
                alert('âŒ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù‡Ø¯ÙŠØ©!');
                return;
            }
            
            if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ© ${gift} Ø¨Ø³Ø¹Ø± ${cost.toLocaleString()} ğŸ’°ØŸ`)) {
                try {
                    const newBalance = window.currentUser.balance - cost;
                    const success = await window.updateUserBalance(newBalance);
                    
                    if (success) {
                        closeGiftSheet();
                        
                        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‡Ø¯ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                        const list = document.getElementById('public-chat-list');
                        const div = document.createElement('div');
                        div.className = `flex gap-2 flex-row-reverse`;
                        div.innerHTML = `
                            <img src="${window.currentUser.photoURL || 'https://i.pravatar.cc/150'}" class="w-8 h-8 rounded-full">
                            <div class="flex flex-col items-end">
                                <span class="text-[9px] opacity-40 mb-0.5">${window.currentUser.displayName}</span>
                                <div class="msg-bubble msg-me" style="font-size: 24px; padding: 15px;">${gift}</div>
                                <span class="text-[8px] opacity-30 mt-1">-${cost.toLocaleString()} ğŸ’°</span>
                            </div>`;
                        list.appendChild(div);
                        list.scrollTop = list.scrollHeight;
                        
                        alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ© ${gift} Ø¨Ù†Ø¬Ø§Ø­!`);
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯ÙŠØ©');
                }
            }
        }

        function openGiftSheet() {
            document.getElementById('gift-sheet').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        }

        function closeGiftSheet() {
            document.getElementById('gift-sheet').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }

        function sendMessage(type) {
            const input = document.getElementById(`${type}-input`);
            if (!input.value.trim()) return;
            
            const list = document.getElementById(`${type}-chat-list`);
            const div = document.createElement('div');
            div.className = `flex gap-2 flex-row-reverse`;
            div.innerHTML = `
                <img src="${window.currentUser?.photoURL || 'https://i.pravatar.cc/150'}" class="w-8 h-8 rounded-full">
                <div class="flex flex-col items-end">
                    <span class="text-[9px] opacity-40 mb-0.5">${window.currentUser?.displayName || 'Ø£Ù†Ø§'}</span>
                    <div class="msg-bubble msg-me">${input.value}</div>
                </div>`;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
            input.value = '';
        }

        function showStore() {
            alert('ğŸ›’ Ø§Ù„Ù…ØªØ¬Ø± Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ Ø³ÙŠØªÙ… Ø¥Ø·Ù„Ø§Ù‚Ù‡ Ù‚Ø±ÙŠØ¨Ø§Ù‹!');
        }

        // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        window.onload = () => {
            const list = document.getElementById('public-chat-list');
            list.innerHTML = `
                <div class="text-center opacity-30 text-[10px] my-4">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø£ÙÙ†Ø§Ù†ØŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ù„Ø³Ù„Ø§Ù…ØªÙƒÙ…</div>
                <div class="text-center opacity-20 text-[9px] my-2">Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¯ÙŠØ©: Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ğŸ</div>
            `;
        };
    </script>
</body>
</html>
