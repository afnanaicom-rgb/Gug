<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afnan Chat - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white flex items-center justify-center h-screen">

    <div class="flex flex-col items-center gap-6">
        <h1 class="text-2xl font-bold mb-4">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø£ÙÙ†Ø§Ù†</h1>
        <button id="google-login" class="px-6 py-3 bg-orange-500 rounded-xl font-bold hover:bg-orange-600">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google</button>
        <div id="login-error" class="text-red-500 text-sm mt-2 hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCyCqrlFUn1UJr29tJGqikSNwsSo5_ieJo",
            authDomain: "afnan-6a676.firebaseapp.com",
            projectId: "afnan-6a676",
            storageBucket: "afnan-6a676.firebasestorage.app",
            messagingSenderId: "751685607902",
            appId: "1:751685607902:web:11c8b40bc6c2a848c2bd4f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ ID ÙØ±ÙŠØ¯
        async function generateUniqueId() {
            const newId = Math.floor(10000000 + Math.random() * 90000000).toString();
            const docRef = doc(db, "usersById", newId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) {
                return newId;
            } else {
                return generateUniqueId(); // Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            }
        }

        // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('google-login').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                let userData;

                if (!userSnap.exists()) {
                    // ØªÙˆÙ„ÙŠØ¯ ID Ø¬Ø¯ÙŠØ¯
                    const newUserId = await generateUniqueId();

                    userData = {
                        uid: user.uid,
                        userId: newUserId,
                        displayName: user.displayName || "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯",
                        email: user.email || "",
                        photoURL: user.photoURL || "https://i.pravatar.cc/150?u=" + user.uid,
                        balance: 27000,
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp()
                    };

                    // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
                    await setDoc(userRef, userData);
                    await setDoc(doc(db, "usersById", newUserId), { uid: user.uid });

                    console.log("ğŸ†• Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡:", newUserId);
                }

                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                window.location.href = "app.html";

            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
                const errorDiv = document.getElementById('login-error');
                errorDiv.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!";
                errorDiv.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
