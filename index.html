<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Afnan Chat - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
body, html { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:'Noto Sans Arabic', sans-serif; display:flex; justify-content:center; align-items:center; }
.login-box { background: rgba(255,255,255,0.05); padding:30px; border-radius:20px; backdrop-filter:blur(15px); width:300px; display:flex; flex-direction:column; gap:15px; text-align:center; }
button { padding:10px; border-radius:12px; border:none; background:#FFA500; color:#000; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>

<div class="login-box">
    <h2 class="font-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google</h2>
    <button id="google-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <div id="status" class="text-sm text-red-500 mt-2"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyCyCqrlFUn1UJr29tJGqikSNwsSo5_ieJo",
    authDomain: "afnan-6a676.firebaseapp.com",
    projectId: "afnan-6a676",
    storageBucket: "afnan-6a676.firebasestorage.app",
    messagingSenderId: "751685607902",
    appId: "1:751685607902:web:11c8b40bc6c2a848c2bd4f"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ØªÙˆÙ„ÙŠØ¯ ID ÙØ±ÙŠØ¯ Ù…ÙƒÙˆÙ† Ù…Ù† 8 Ø£Ø±Ù‚Ø§Ù…
async function generateUniqueId() {
    let unique = false;
    let newId;
    const usersRef = collection(db, "users");

    while (!unique) {
        newId = Math.floor(10000000 + Math.random() * 90000000).toString();
        const snapshot = await getDocs(usersRef);
        unique = !snapshot.docs.some(doc => doc.data().userId === newId);
    }
    return newId;
}

document.getElementById('google-login').onclick = async () => {
    try {
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);

        let userData;

        if (!userSnap.exists()) {
            // Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
            const newId = await generateUniqueId();
            userData = {
                uid: user.uid,
                userId: newId,
                displayName: user.displayName || "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯",
                email: user.email,
                photoURL: user.photoURL || "https://i.pravatar.cc/150?u=" + user.uid,
                balance: 27000,
                createdAt: serverTimestamp(),
                lastLogin: serverTimestamp()
            };
            await setDoc(userRef, userData);
            console.log("ğŸ†• Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡:", newId);
        } else {
            // Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯
            userData = userSnap.data();
            console.log("ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯:", userData.userId);
            await setDoc(userRef, { lastLogin: serverTimestamp() }, { merge: true });
        }

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù„Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        localStorage.setItem('currentUser', JSON.stringify(userData));

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© app.html
        window.location.href = "app.html";

    } catch (error) {
        console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
        document.getElementById('status').textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!";
    }
};
</script>

</body>
</html>
